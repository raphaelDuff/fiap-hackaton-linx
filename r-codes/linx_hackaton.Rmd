---
title: "Linx - Hackathon"
author: "Raphael Prates"
date: "17/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importando bibliotecas

```{r }
library(datetime)
library(httr)
library(data.table)
library(dplyr)
library(lubridate)
library(utils)
library(tidyverse)
library(stringr)
```

## Importando dados

```{r}
load("C:/Users/Administrator/hackton/fiap-hackathon/r-codes/dados_linx/linx_all_transactions.RData")
```

## Quick Look

```{r }
glimpse(df)
```

```{r }
df$productTotal <- as.numeric(as.character(df$productTotal))
df$productTotal <- round(df$productTotal, 2)
```

```{r }
glimpse(df)
```

## Numero de encrypted_domain
```{r }
df$encrypted_domain <- as.factor(df$encrypted_domain)
print(paste0("Numero de encrypted_domain unicos: ",length(levels(df$encrypted_domain))))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
unique(levels(df$encrypted_domain))
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
df$encrypted_domain <- str_replace(df$encrypted_domain, '3130346238346439613630366662323861653139623466366639363939393662', 'A')
df$encrypted_domain <- str_replace(df$encrypted_domain, '3132336536623434373931646265346333343863663330323262353339366331', 'B')
df$encrypted_domain <- str_replace(df$encrypted_domain, '6139646137356433363237396637323937336161383832316332663038646335', 'C')
df$encrypted_domain <- as.factor(df$encrypted_domain)
```

## Criando coluna para hora do dia
```{r echo=TRUE, message=FALSE, warning=FALSE}
df$hour <-  as.time(as.datetime(df$dateTime, format = '%Y-%m-%dT%H'))
df$dateTime <- date(df$dateTime)
#df$dia.semana <- weekdays(df$dateTime)
#df$dia.mes <- sapply(df$dateTime, day)
```

## Agrupando por varejista de postos de combustiveis e PDV
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_c <- df %>% 
  filter(encrypted_domain == 'C') %>% 
  group_by(encrypted_cnpj, dateTime) %>% 
  summarize(vendaTotal = sum(productTotal))
```
## Somando todas as vendas do PDV
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_c_sum <- df_c %>%
  group_by(encrypted_cnpj) %>% 
  summarize(vendaTotal = sum(vendaTotal)) %>% 
  arrange(desc(vendaTotal))
  
```

## Dividindo os PDVs por tres categorias de acordo com a venda total
```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(df_c_sum)
grupo_ouro <- df_c_sum %>% 
  filter(vendaTotal >= 13889.1) # Valores maiores do que o terceiro quartil

  
```

## Tirando na analise os PDV menores
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_c_filtered <- df_c %>% 
  filter(encrypted_cnpj %in% grupo_ouro$encrypted_cnpj | 
           encrypted_cnpj %in% grupo_prata$encrypted_cnpj)
```

## Criando coluna com a categoria de PDV "Ouro" e "Prata"
```{r echo=TRUE, message=FALSE, warning=FALSE}
categoria_func <- function(x) {
  if (x %in% grupo_ouro$encrypted_cnpj) {
    return('Ouro')
  }
  if (x %in% grupo_prata$encrypted_cnpj) {
    return('Prata')
  }
}

df_c_filtered$Categoria <- sapply(df_c_filtered$encrypted_cnpj, categoria_func)
```

## Agrupando por Categoria
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek_ouro <- df_c_filtered %>% 
  filter(Categoria == "Ouro")

df_dayweek_prata <- df_c_filtered %>% 
  filter(Categoria == "Prata")
```

## Removendo os outliers para o Grupo Ouro
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek_ouro <- df_dayweek_ouro %>% 
  filter(vendaTotal  <= 463 | vendaTotal > 80)

```

## Removendo os outliers para o Grupo Prata
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek_ouro <- df_dayweek_ouro %>% 
  filter(vendaTotal  <= 463 | vendaTotal > 80)

```

## Criando coluna para dia da semana
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek_ouro$dateTime <- date(df_dayweek_ouro$dateTime)
df_dayweek_ouro$dia.semana <- weekdays(df_dayweek_ouro$dateTime)
```


## Agrupando por dia de semana
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek <- df_dayweek_ouro %>% 
  group_by(Categoria, dia.semana) %>% 
  summarize(venda.Media = mean(vendaTotal))

df_dayweek$dia.semana <- factor(df_dayweek$dia.semana, levels = c("segunda-feira", "terça-feira", "quarta-feira", "quinta-feira", "sexta-feira", "sábado", "domingo"))

df_dayweek <- df_dayweek[order(df_dayweek$dia.semana),]
```

## Vendas dos PDVs "Ouro" por dia da semana
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek %>%
  ggplot(aes(x=dia.semana,y=venda.Media,
             color = Categoria,
             group = Categoria)) + 
  geom_point() + 
  geom_line(linetype='dotted')
```

## Vendas dos PDVs "Prata" por dia da semana
```{r echo=TRUE, message=FALSE, warning=FALSE}
df_dayweek_prata %>%
  ggplot(aes(x=dia.semana,y=venda.Media,
             color = Categoria,
             group = Categoria)) + 
  geom_point() + 
  geom_line(linetype='dotted')
```


## Links Uteis para Forecasting
https://docs.microsoft.com/pt-br/azure/machine-learning/service/how-to-auto-train-forecast
https://medium.com/techbloghotmart/o-que-s%C3%A3o-s%C3%A9ries-temporais-e-como-aplicar-em-machine-learning-6ea5d94bec78